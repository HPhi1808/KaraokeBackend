<div class="card shadow border-0 mb-4">
    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
        <h5 class="m-0 font-weight-bold text-primary">Danh s√°ch Ng∆∞·ªùi d√πng</h5>
        <div class="input-group" style="width: 300px;">
            <input type="text" id="searchUser" class="form-control" placeholder="T√¨m t√™n, email...">
            <button class="btn btn-primary">
                <i class="bi bi-search"></i>
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="text-center">Avatar</th>
                        <th>H·ªç t√™n</th>
                        <th>Username</th>
                        <th>Email</th>
                        <th class="text-center">Vai tr√≤</th>
                        <th>Ng√†y t·∫°o</th>
                        <th class="text-center">H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="messageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="bi bi-envelope-exclamation"></i> G·ª≠i C·∫£nh B√°o/Tin Nh·∫Øn</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="msgForm">
                    <input type="hidden" id="msgUserId">
                    <div class="mb-3">
                        <label class="form-label">Ng∆∞·ªùi nh·∫≠n:</label>
                        <input type="text" class="form-control" id="msgUserName" disabled readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Lo·∫°i tin nh·∫Øn</label>
                        <select class="form-select" id="msgType">
                            <option value="warning">‚ö†Ô∏è C·∫£nh b√°o vi ph·∫°m</option>
                            <option value="info">‚ÑπÔ∏è Th√¥ng b√°o h·ªá th·ªëng</option>
                            <option value="success">üéÅ Qu√† t·∫∑ng/Khuy·∫øn kh√≠ch</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ti√™u ƒë·ªÅ</label>
                        <input type="text" class="form-control" id="msgTitle" placeholder="V√≠ d·ª•: C·∫£nh b√°o vi ph·∫°m"
                            required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">N·ªôi dung chi ti·∫øt</label>
                        <textarea class="form-control" id="msgContent" rows="4" placeholder="Nh·∫≠p n·ªôi dung..."
                            required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-primary" onclick="window.submitMessage()">G·ª≠i ngay</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="lockModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-lock-fill"></i> Kho√° T√†i Kho·∫£n</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>B·∫°n ƒëang thao t√°c v·ªõi user: <strong id="lockUserName"></strong></p>
                <input type="hidden" id="lockUserId">

                <div class="mb-3">
                    <label class="form-label fw-bold">Ch·ªçn th·ªùi gian kho√°:</label>
                    <div class="list-group">
                        <label class="list-group-item">
                            <input class="form-check-input me-1" type="radio" name="lockDuration" value="1h" checked>
                            Kho√° 1 Gi·ªù
                        </label>
                        <label class="list-group-item">
                            <input class="form-check-input me-1" type="radio" name="lockDuration" value="24h">
                            Kho√° 24 Gi·ªù (1 ng√†y)
                        </label>
                        <label class="list-group-item">
                            <input class="form-check-input me-1" type="radio" name="lockDuration" value="7d">
                            Kho√° 7 Ng√†y
                        </label>
                        <label class="list-group-item">
                            <input class="form-check-input me-1" type="radio" name="lockDuration" value="30d">
                            Kho√° 30 Ng√†y
                        </label>
                        <label class="list-group-item list-group-item-danger">
                            <input class="form-check-input me-1" type="radio" name="lockDuration" value="forever">
                            Kho√° Vƒ©nh Vi·ªÖn (C·∫•m c·ª≠a)
                        </label>
                        <label class="list-group-item list-group-item-success">
                            <input class="form-check-input me-1" type="radio" name="lockDuration" value="unlock">
                            üîì M·ªû KHO√Å (User ho·∫°t ƒë·ªông l·∫°i)
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-danger" onclick="window.submitLock()">X√°c nh·∫≠n</button>
            </div>
        </div>
    </div>
</div>



<script>
    // --- 1. ƒê·ªäNH NGHƒ®A C√ÅC H√ÄM H√ÄNH ƒê·ªòNG ---

    window.toggleRole = async function (id, currentRole) {
        // Ch·ªâ cho ph√©p ƒë·ªïi user <-> admin, kh√¥ng ƒë·ªïi guest
        const newRole = currentRole === 'admin' ? 'user' : 'admin';
        if (!confirm(`B·∫°n mu·ªën ƒë·ªïi quy·ªÅn user n√†y th√†nh ${newRole.toUpperCase()}?`)) return;

        const res = await api(`/api/admin/users/${id}/role`, {
            method: 'PATCH',
            body: JSON.stringify({ role: newRole })
        });

        if (res && (res.status === 'success' || res.user)) {
            window.initUsers();
        } else {
            alert('L·ªói: ' + (res?.message || 'Kh√¥ng th·ªÉ ƒë·ªïi quy·ªÅn'));
        }
    };

    window.deleteUser = async function (id) {
        if (!confirm('H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c. X√ìA ng∆∞·ªùi d√πng n√†y?')) return;
        const res = await api(`/api/admin/users/${id}`, { method: 'DELETE' });
        if (res && res.status === 'success') {
            window.initUsers();
        } else {
            alert('L·ªói: ' + (res?.message || 'Kh√¥ng x√≥a ƒë∆∞·ª£c'));
        }
    };

    window.openMsgModal = function (userId, userName) {
        // ƒêi·ªÅn d·ªØ li·ªáu v√†o form
        const idInput = document.getElementById('msgUserId');
        const nameInput = document.getElementById('msgUserName');

        if (idInput) idInput.value = userId;
        if (nameInput) nameInput.value = userName;

        // Reset form
        document.getElementById('msgTitle').value = '';
        document.getElementById('msgContent').value = '';

        const bs = window.bootstrap || (typeof bootstrap !== 'undefined' ? bootstrap : null);

        if (bs) {
            const modalEl = document.getElementById('messageModal');
            let modal = bs.Modal.getInstance(modalEl);
            if (!modal) {
                modal = new bs.Modal(modalEl);
            }
            modal.show();
        } else {
            alert("L·ªói: Kh√¥ng t√¨m th·∫•y th∆∞ vi·ªán Bootstrap JS! H√£y ki·ªÉm tra l·∫°i file base.html");
        }
    };

    window.submitMessage = async function () {
        const userId = document.getElementById('msgUserId').value;
        const title = document.getElementById('msgTitle').value;
        const message = document.getElementById('msgContent').value;
        const type = document.getElementById('msgType').value;

        if (!title || !message) {
            alert('Vui l√≤ng nh·∫≠p ƒë·ªß ti√™u ƒë·ªÅ v√† n·ªôi dung!');
            return;
        }

        const btn = document.querySelector('#messageModal .btn-primary');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<div class="spinner-border spinner-border-sm"></div> ƒêang g·ª≠i...';

        const res = await api(`/api/admin/users/${userId}/message`, {
            method: 'POST',
            body: JSON.stringify({ title, message, type })
        });

        btn.disabled = false;
        btn.innerHTML = originalText;

        if (res && res.status === 'success') {
            alert('ƒê√£ g·ª≠i tin nh·∫Øn th√†nh c√¥ng!');
            const modalEl = document.getElementById('messageModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();
        } else {
            alert('L·ªói: ' + (res?.message || 'Kh√¥ng g·ª≠i ƒë∆∞·ª£c'));
        }
    };


    window.openLockModal = function (id, name) {
        document.getElementById('lockUserId').value = id;
        document.getElementById('lockUserName').innerText = name;

        // Reset radio v·ªÅ m·∫∑c ƒë·ªãnh 24h
        document.querySelector('input[name="lockDuration"][value="24h"]').checked = true;

        if (typeof bootstrap !== 'undefined') {
            const modalEl = document.getElementById('lockModal');
            const modal = new bootstrap.Modal(modalEl);
            modal.show();
        }
    };

    // H√ÄM M·ªöI: G·ª≠i l·ªánh Kho√°
    window.submitLock = async function () {
        const userId = document.getElementById('lockUserId').value;
        const duration = document.querySelector('input[name="lockDuration"]:checked').value;

        const btn = document.querySelector('#lockModal .btn-danger');
        const oldText = btn.innerText;
        btn.innerText = 'ƒêang x·ª≠ l√Ω...';
        btn.disabled = true;

        const res = await api(`/api/admin/users/${userId}/lock`, {
            method: 'POST',
            body: JSON.stringify({ duration })
        });

        btn.innerText = oldText;
        btn.disabled = false;

        if (res && res.status === 'success') {
            alert(res.message);
            const modalEl = document.getElementById('lockModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();
            window.initUsers(); // Load l·∫°i b·∫£ng ƒë·ªÉ th·∫•y icon kho√°
        } else {
            alert('L·ªói: ' + (res?.message || 'Th·∫•t b·∫°i'));
        }
    }

    // --- 2. H√ÄM INIT CH√çNH ---
    window.initUsers = async function () {
        // T√¨m ki·∫øm
        const searchInput = document.getElementById('searchUser');
        if (searchInput) {
            searchInput.oninput = function (e) {
                const kw = e.target.value.toLowerCase();
                document.querySelectorAll('#usersTableBody tr').forEach(row => {
                    const text = row.innerText.toLowerCase();
                    row.style.display = text.includes(kw) ? '' : 'none';
                });
            };
        }

        // T·∫£i d·ªØ li·ªáu
        const tbody = document.getElementById('usersTableBody');
        if (!tbody) return;

        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4"><div class="spinner-border text-primary"></div> ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';

        const data = await api('/api/admin/users');

        if (!data || data.status === 'error' || data.error) {
            tbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger py-4">
                Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu<br>${data?.message || data?.error || 'L·ªói k·∫øt n·ªëi'}
            </td></tr>`;
            return;
        }

        if (Array.isArray(data) && data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4">Ch∆∞a c√≥ ng∆∞·ªùi d√πng n√†o.</td></tr>';
            return;
        }

        tbody.innerHTML = '';
        const list = Array.isArray(data) ? data : (data.users || []);

        // L·∫•y th√¥ng tin ng∆∞·ªùi xem hi·ªán t·∫°i
        let currentUserId = null;
        let currentUserRole = '';
        try {
            const token = localStorage.getItem('access_token');
            if (token) {
                const payload = JSON.parse(atob(token.split('.')[1]));
                currentUserId = payload.user_id;
                currentUserRole = payload.role;
            }
        } catch (e) { }

        list.forEach(u => {
            if (u.role === 'own' && currentUserRole !== 'own') return;

            // --- KI·ªÇM TRA KHO√Å
            const isLocked = u.locked_until && new Date(u.locked_until) > new Date();

            const tr = document.createElement('tr');
            // N·∫øu b·ªã kho√° -> Th√™m class l√†m x√°m d√≤ng ƒë√≥ ƒëi
            if (isLocked) tr.classList.add('table-secondary');

            let actionButtons = '';

            if (u.id !== currentUserId) {
                const canEdit = currentUserRole === 'own' || (currentUserRole === 'admin' && (u.role === 'user' || u.role === 'guest'));

                if (canEdit) {
                    const safeName = (u.full_name || u.username).replace(/'/g, "\\'");

                    if (u.role !== 'own' && u.role !== 'guest') {
                        const btnClass = u.role === 'admin' ? 'btn-secondary' : 'btn-warning';
                        const btnText = u.role === 'admin' ? 'H·∫° User' : 'L√™n Admin';
                        actionButtons += `
                            <button class="btn btn-sm ${btnClass} me-1" onclick="window.toggleRole(${u.id},'${u.role}')">
                                ${btnText}
                            </button>`;
                    }

                    // N√∫t Kho√° T√†i Kho·∫£n
                    if (u.role !== 'guest') {
                        const lockIcon = isLocked ? '<i class="bi bi-unlock-fill"></i>' : '<i class="bi bi-lock-fill"></i>';
                        const lockClass = isLocked ? 'btn-success' : 'btn-dark';
                        const lockTitle = isLocked ? 'M·ªü kho√° t√†i kho·∫£n' : 'Kho√° t√†i kho·∫£n';

                        actionButtons += `
                            <button class="btn btn-sm ${lockClass} me-1" 
                                onclick="window.openLockModal(${u.id}, '${safeName}')" 
                                title="${lockTitle}">
                                ${lockIcon}
                            </button>`;
                    }

                    // 3. N√∫t X√≥a
                    actionButtons += `<button class="btn btn-sm btn-danger me-1" onclick="window.deleteUser(${u.id})"><i class="bi bi-trash"></i></button>`;

                    // 4. N√∫t Tin nh·∫Øn
                    actionButtons += `
                        <button class="btn btn-sm btn-info text-white" 
                            onclick="window.openMsgModal(${u.id}, '${safeName}')" 
                            title="G·ª≠i tin nh·∫Øn">
                            <i class="bi bi-envelope"></i>
                        </button>`;
                }
            } else {
                actionButtons = '<span class="badge bg-secondary">B·∫°n</span>';
            }

            // --- [LOGIC M·ªöI: ICON TR·∫†NG TH√ÅI C·∫†NH T√äN] ---
            const statusBadge = isLocked
                ? '<span class="badge bg-danger ms-2"><i class="bi bi-lock-fill"></i> Locked</span>'
                : '';

            tr.innerHTML = `
              <td class="text-center">
                <img src="${u.avatar_url || 'https://via.placeholder.com/50'}" class="rounded-circle border" width="40" height="40" style="object-fit: cover;">
              </td>
              <td class="fw-bold text-dark">
                  ${u.full_name || 'Ch∆∞a ƒë·∫∑t t√™n'} 
                  ${statusBadge}
              </td>
              <td class="text-muted">@${u.username}</td>
              <td>${u.email}</td>
              <td class="text-center">
                <span class="badge ${u.role === 'own' ? 'bg-dark' : u.role === 'admin' ? 'bg-danger' : 'bg-success'}">
                  ${u.role.toUpperCase()}
                </span>
              </td>
              <td>${new Date(u.created_at).toLocaleDateString('vi-VN')}</td>
              <td class="text-center">${actionButtons}</td>
            `;
            tbody.appendChild(tr);
        });
    };

    window.initUsers();
</script>