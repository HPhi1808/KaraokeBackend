<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Karaoke Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; }
        .card { margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .song-img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark mb-4">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">üé§ Karaoke Admin Panel</span>
        </div>
    </nav>

    <div class="container">
        <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="songs-tab" data-bs-toggle="tab" data-bs-target="#songs" type="button">üéµ Qu·∫£n l√Ω B√†i H√°t</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button">üë• Qu·∫£n l√Ω Ng∆∞·ªùi D√πng</button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            
            <div class="tab-pane fade show active" id="songs">
                
                <div class="card p-3">
                    <h5 class="mb-3"><i class="bi bi-plus-circle-fill text-success"></i> Th√™m B√†i H√°t M·ªõi</h5>
                    <form id="addSongForm" class="row g-3">
                        <div class="col-md-4"><input type="text" class="form-control" id="title" placeholder="T√™n b√†i h√°t (V√≠ d·ª•: Em G√°i M∆∞a)" required></div>
                        <div class="col-md-4"><input type="text" class="form-control" id="artist" placeholder="Ca sƒ© (V√≠ d·ª•: H∆∞∆°ng Tr√†m)" required></div>
                        <div class="col-md-4"><input type="text" class="form-control" id="genre" placeholder="Th·ªÉ lo·∫°i (Pop, Ballad...)"></div>
                        <div class="col-md-6"><input type="text" class="form-control" id="videoUrl" placeholder="Link Youtube Video" required></div>
                        <div class="col-md-6"><input type="text" class="form-control" id="imageUrl" placeholder="Link ·∫¢nh b√¨a (Thumbnail)"></div>
                        <div class="col-12 text-end">
                            <button type="submit" class="btn btn-success fw-bold">L∆∞u B√†i H√°t</button>
                        </div>
                    </form>
                </div>

                <div class="card p-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5>Danh S√°ch B√†i H√°t</h5>
                        <div class="input-group" style="width: 300px;">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" id="searchInput" class="form-control" placeholder="T√¨m t√™n b√†i h√°t...">
                        </div>
                    </div>
                    
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr><th>ID</th><th>·∫¢nh</th><th>T√™n B√†i</th><th>Ca Sƒ©</th><th>H√†nh ƒê·ªông</th></tr>
                        </thead>
                        <tbody id="songTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane fade" id="users">
                <div class="card p-3">
                    <h5>Danh S√°ch Ng∆∞·ªùi D√πng</h5>
                    <table class="table table-hover">
                        <thead><tr><th>ID</th><th>Username</th><th>Email</th><th>H·ªç T√™n</th><th>Vai tr√≤</th><th>H√†nh ƒê·ªông</th></tr></thead>
                        <tbody id="userTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = '/api'; // D√πng ƒë∆∞·ªùng d·∫´n t∆∞∆°ng ƒë·ªëi ƒë·ªÉ t·ª± nh·∫≠n host
        let allSongs = []; // Bi·∫øn l∆∞u to√†n b·ªô b√†i h√°t ƒë·ªÉ t√¨m ki·∫øm

        // --- 1. QU·∫¢N L√ù B√ÄI H√ÅT ---

        // H√†m t·∫£i danh s√°ch
        async function loadSongs() {
            try {
                const res = await fetch(`${API_URL}/songs`);
                allSongs = await res.json();
                
                // Debug l·ªói undefined: In d·ªØ li·ªáu ra console ƒë·ªÉ ki·ªÉm tra
                console.log("D·ªØ li·ªáu b√†i h√°t t·ª´ Server:", allSongs);

                renderSongTable(allSongs);
            } catch (err) {
                console.error("L·ªói t·∫£i b√†i h√°t:", err);
            }
        }

        // H√†m v·∫Ω b·∫£ng (Render)
        function renderSongTable(songs) {
            const tbody = document.getElementById('songTableBody');
            tbody.innerHTML = '';

            if (songs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">Kh√¥ng t√¨m th·∫•y b√†i h√°t n√†o</td></tr>';
                return;
            }

            songs.forEach(s => {
                // Ki·ªÉm tra xem tr∆∞·ªùng ID c√≥ t·ªìn t·∫°i kh√¥ng, n·∫øu kh√¥ng th·ª≠ c√°c bi·∫øn th·ªÉ kh√°c
                const id = s.id || s.ID || s.Id || 'L·ªói ID';
                const artist = s.artist || s.Artist || 'Ch∆∞a c·∫≠p nh·∫≠t';
                const image = s.image_url || 'https://placehold.co/100x100?text=No+Image';

                tbody.innerHTML += `
                    <tr>
                        <td>${id}</td>
                        <td><img src="${image}" class="song-img"></td>
                        <td class="fw-bold">${s.title}</td>
                        <td>${artist}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteSong(${id})">
                                <i class="bi bi-trash-fill"></i> X√≥a
                            </button>
                        </td>
                    </tr>`;
            });
        }

        // S·ª± ki·ªán T√¨m ki·∫øm (L·ªçc client-side cho nhanh)
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const keyword = e.target.value.toLowerCase();
            const filteredSongs = allSongs.filter(s => 
                s.title.toLowerCase().includes(keyword) || 
                (s.artist && s.artist.toLowerCase().includes(keyword))
            );
            renderSongTable(filteredSongs);
        });

        // Th√™m b√†i h√°t
        document.getElementById('addSongForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const song = {
                title: document.getElementById('title').value,
                artist: document.getElementById('artist').value,
                genre: document.getElementById('genre').value,
                video_url: document.getElementById('videoUrl').value,
                image_url: document.getElementById('imageUrl').value
            };

            await fetch(`${API_URL}/admin/songs`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(song)
            });
            alert('ƒê√£ th√™m b√†i h√°t!');
            document.getElementById('addSongForm').reset();
            loadSongs();
        });

        // X√≥a b√†i h√°t
        async function deleteSong(id) {
            if(confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i n√†y?')) {
                await fetch(`${API_URL}/admin/songs/${id}`, { method: 'DELETE' });
                loadSongs();
            }
        }

        // --- 2. QU·∫¢N L√ù NG∆Ø·ªúI D√ôNG ---
        async function loadUsers() {
            try {
                const res = await fetch(`${API_URL}/admin/users`);
                const users = await res.json();
                const tbody = document.getElementById('userTableBody');
                tbody.innerHTML = '';
                users.forEach(u => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${u.id}</td>
                            <td>${u.username}</td>
                            <td>${u.email}</td>
                            <td>${u.full_name}</td>
                            <td><span class="badge bg-${u.role === 'admin' ? 'danger' : 'primary'}">${u.role}</span></td>
                            <td>
                                ${u.role !== 'admin' ? `<button class="btn btn-sm btn-danger" onclick="deleteUser(${u.id})">X√≥a</button>` : ''}
                            </td>
                        </tr>`;
                });
            } catch (err) { console.error(err); }
        }

        async function deleteUser(id) {
            if(confirm('C·∫¢NH B√ÅO: X√≥a ng∆∞·ªùi d√πng n√†y s·∫Ω kh√¥ng th·ªÉ kh√¥i ph·ª•c! Ti·∫øp t·ª•c?')) {
                await fetch(`${API_URL}/admin/users/${id}`, { method: 'DELETE' });
                loadUsers();
            }
        }

        // Ch·∫°y khi t·∫£i trang
        loadSongs();
        loadUsers();
    </script>
</body>
</html>